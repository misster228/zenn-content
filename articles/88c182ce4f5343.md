---
title: "kubesprayã«ã‚ˆã‚‹Kubernetesç’°å¢ƒæ§‹ç¯‰ï¼šäº‹å‰è¨­å®šã‹ã‚‰å®Ÿè¡Œã¾ã§"
emoji: "ğŸ’¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Kubernetes","Ansible"]
published: true
---

# kubesprayã«ã‚ˆã‚‹Kubernetesç’°å¢ƒæ§‹ç¯‰ï¼šäº‹å‰è¨­å®šã‹ã‚‰å®Ÿè¡Œã¾ã§

ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã§éšåˆ†ä¹…ã—ã¶ã‚Šã«Kubernetes (k8s) ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹æ©Ÿä¼šãŒã‚ã‚Šã€ã›ã£ã‹ããªã®ã§kubesprayã‚’ä½¿ã£ã¦ã¿ã¾ã—ãŸã€‚å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã ã‘ã§ãªãã€ã„ã‚ã„ã‚ãªãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ãŸã®ã§ã™ãŒäº‹å‰è¨­å®šãªã©ã§å¤ã„æƒ…å ±ãŒæ•£è¦‹ã•ã‚Œã¾ã—ãŸã€‚
ï¼ˆã“ã‚Œã°ã£ã‹ã‚Šã¯ã—ã‚‡ã†ãŒãªã„ã€‚ï¼‰
ä»Šã¯å„ãƒã‚·ãƒ³ã«å¯¾ã—ã¦ä½•ã‚’è¨­å®šã—ã¦ãŠã‹ãªã„ã¨ã„ã‘ãªã„ã®ã‹ã‚’æ•´ç†ã—ã¤ã¤ã€kubesprayã‚’ä½¿ç”¨ã—ãŸã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹ç¯‰æ–¹æ³•ã‚’ã¾ã¨ã‚ã¾ã™ã€‚ä»Šå›ã¯kubespayã®v2.28.0ã‚’ä½¿ã£ã¦æ¤œè¨¼ã—ã¾ã—ãŸã€‚

## ç§ãŒæ°—ã«ãªã£ã¦ã„ãŸã¨ã“ã‚

- net.ipv4.ip_forwardã‚’äº‹å‰ã«1ã«è¨­å®šã™ã‚‹å¿…è¦ã¯ãªã„ã€‚
  ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€ã¨äº‹å‰ã«è¨­å®šã—ã‚ã¨æ›¸ã„ã¦ã„ã¾ã™ãŒã€kubesprayä¸­ã§è¨­å®šãŒå…¥ã‚Šã¾ã—ãŸã€‚
- äº‹å‰ã«è¨­å®šã—ãªã„ãªã‚‰firewallã¯æ­¢ã‚ã¦ãŠãã€‚
  kubesprayã®ä¸­ã«firewall/ufwåœæ­¢ç”¨ã®playbookãŒã‚ã‚‹ã®ã§ãã‚Œã‚’ä½¿ã£ã¦è¨­å®šã™ã‚Œã°å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
- SELinuxã‚‚ç„¡åŠ¹åŒ–ã—ã¦æ§‹ç¯‰ã™ã‚‹ã®ãŒç„¡é›£ã€‚
  SELinuxã‚’Permissiveã«ã—ãŸæ™‚ã¨ã€Enforcingã«ã—ãŸæ™‚ã®çµæœã§RECAPã‚’æ¯”è¼ƒã—ã¦ã‚‚failed/ignoredã®æ•°ã«é•ã„ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãŸã ã—ã€SELinuxã®dontauditãƒ«ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã‹ã‚‰kubesprayã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã„ãã‚‰ã‹æ‹’å¦ãƒ­ã‚°ãŒå‡ºã¦ã„ã¾ã—ãŸã€‚
  ä»Šå›ã¯è©³ç´°ã¾ã§ã¯èª¿ã¹ã¾ã›ã‚“ã§ã—ãŸãŒã€Permissiveã«è¨­å®šã—ã¦ãŠãã®ãŒç„¡é›£ã‹ãªã¨æ€ã„ã¾ã™ã€‚ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§ã¯kubesprayã®å®Ÿè¡Œä¸­ã€SELinuxã‚’Permissiveãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ã¦ãã‚Œã¾ã™ã€‚ï¼‰

ã“ã“ã‚‰è¾ºã®è©³ã—ã„è©±ã¯[kubesprayã‚’ä½¿ã†ã«ã‚ãŸã£ã¦èª¿ã¹ãŸã“ã¨](#kubesprayã‚’ä½¿ã†ã«ã‚ãŸã£ã¦èª¿ã¹ãŸã“ã¨)ã«è¨˜è¼‰ã—ã¾ã™ã€‚

## kubesprayã¨ã¯

Ansibleã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ãŸk8sã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼è‡ªå‹•æ§‹ç¯‰ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Virtual Machine (VM) ã‹ã‚‰AWSãªã©ã®ã‚¯ãƒ©ã‚¦ãƒ‰ã¾ã§ã€å¹…åºƒã„ç’°å¢ƒã«å¯¾ã—ã¦Production Readyãªk8sã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚


## ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆ

ä»Šå›ä½¿ã£ãŸç’°å¢ƒã§ã™ã€‚Hyper-Vä¸Šã®VMã«k8sã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚WSL2ãƒã‚·ãƒ³ã‹ã‚‰kubesprayã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

### VM

| VMå | OS | vCPU | ãƒ¡ãƒ¢ãƒª | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | eth1ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ | å½¹å‰² |
|------|----|----- |--------|--------|------------|------|
| alma1 | AlmaLinux 9.6 | 2 | 4GB | 20GB | 10.10.1.10/24 | ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ |
| alma-w1 | AlmaLinux 9.6 | 2 | 2GB | 20GB | 10.10.1.11/24 | ãƒ¯ãƒ¼ã‚«ãƒ¼ |
| alma-w2 | AlmaLinux 9.6 | 2 | 2GB | 20GB | 10.10.1.12/24 | ãƒ¯ãƒ¼ã‚«ãƒ¼ |

### WSL

OS: AlmaLinux 9.6  
Python3: 3.12.9

### æ§‹æˆå›³

```mermaid
graph TB
    subgraph "WSL2"
        WSL["AlmaLinux 9.6<br/>Ansible Controller"]
    end
    
    subgraph "Hyper-V"
        VSWITCH["Internal vSwitch<br/>10.10.1.0/24"]
        DEFSWITCH["Default Switch<br/>(NAT)"]
        
        VM1["alma1<br/>eth1: 10.10.1.10"]
        VM2["alma-w1<br/>eth1: 10.10.1.11"]
        VM3["alma-w2<br/>eth1: 10.10.1.12"]
    end
    
    subgraph "Internet"
        INTERNET["Internet"]
    end
    
    VM1 <-->|eth0| DEFSWITCH
    VM2 <-->|eth0| DEFSWITCH
    VM3 <-->|eth0| DEFSWITCH
    
    VM1 <-->|eth1| VSWITCH
    VM2 <-->|eth1| VSWITCH
    VM3 <-->|eth1| VSWITCH
    
    WSL <-->|Internal Network| VSWITCH
    DEFSWITCH <-->|NAT| INTERNET
    
    classDef vm fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef wsl fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef network fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef defswitch fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    
    class VM1,VM2,VM3 vm
    class WSL wsl
    class VSWITCH network
    class DEFSWITCH defswitch
    class INTERNET network
```

## äº‹å‰æº–å‚™

kubesprayã¯Ansibleã‚’ä½¿ã£ã¦k8sã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã®ã§ã€Ansibleã®å®Ÿè¡Œã«å¿…è¦ãªã‚‚ã®ã¯ä¸€é€šã‚Šãã‚ãˆã¦ãŠãã¾ã—ã‚‡ã†ã€‚

### Python3ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

kubesprayã®v2.28.0ã§ã¯Ansibleå®Ÿè¡Œãƒã‚·ãƒ³(WSL2å´)ã§åˆ©ç”¨ã™ã‚‹Python3ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚é©åˆ‡ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ã‚‡ã†ã€‚
ã¾ãŸã€RHEL9ã®cloneã§ã‚ã‚‹Alma Linux 9ç³»ã§ã¯Pythonã‚’è¤‡æ•°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚‚alternativesã®è¨­å®šãŒå…¥ã‚Šã¾ã›ã‚“ã€‚å¿…è¦ãªã‚‰æ‰‹å‹•ã§è¨­å®šã—ã¾ã—ã‚‡ã†ã€‚

WSL2ã§ä»¥ä¸‹å®Ÿè¡Œ
```
$ sudo dnf install python3.12
$ sudo alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1
$ sudo alternatives --config python3
```

### éµã®ä½œæˆãƒ»ç™»éŒ²

WSL2ã®ãƒã‚·ãƒ³ã§sshã‚¢ã‚¯ã‚»ã‚¹ç”¨ã®å…¬é–‹éµãƒ»ç§˜å¯†éµã‚’ä½œæˆã—ã€å„VMã«ç™»éŒ²ã—ã¾ã™ã€‚

```{bash}
$ ssh-keygen -t ed25519
$ ssh-copy-id -i ~/.ssh/id_ed25519.pub [ansibleå®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼]@[ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ã®IP]
```

ssh-copy-idã‚³ãƒãƒ³ãƒ‰ã¯å„ã‚µãƒ¼ãƒãƒ¼ã«å‘ã‹ã£ã¦å®Ÿè¡Œã—ã¾ã™ã€‚

## kubesprayã®æº–å‚™ãƒ»è¨­å®š

ã•ã¦ã€æœ¬é¡Œã«å…¥ã‚Šã¾ã™ã€‚ã“ã“ã‹ã‚‰ã¯kubesprayã‚’æº–å‚™ã—ã¾ã™ã€‚

### kubesprayã®ã‚³ãƒ¼ãƒ‰ã‚’æº–å‚™

kubesprayã®ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’cloneã—ã¾ã™ã€‚
ä»Šå›ã¯2025å¹´7æœˆ15æ—¥æ™‚ç‚¹ã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚ã‚‹v2.28ã®ãƒ–ãƒ©ãƒ³ãƒã‚’æŒ‡å®šã—ã¦cloneã—ã¾ã™ã€‚

```{bash}
$ git clone git@github.com:kubernetes-sigs/kubespray.git -b v2.28.0
```

### Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

kubesprayã®å®Ÿè¡Œã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚[æ‰‹é †](https://kubespray.io/#/docs/ansible/ansible?id=installing-ansible)é€šã‚Šã«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```
$ VENVDIR=kubespray-venv
$ KUBESPRAYDIR=kubespray
$ python3 -m venv $VENVDIR
$ source $VENVDIR/bin/activate
(kubespray-venv) $ cd $KUBESPRAYDIR
(kubespray-venv) $ pip install -U -r requirements.txt
```

### inventoryã®æº–å‚™

å…ƒã®ã‚³ãƒ¼ãƒ‰ã«å­˜åœ¨ã™ã‚‹ä»¥ä¸‹ã®inventoryã‚’ç·¨é›†ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚

> kubespray/inventory/sample/inventory.ini

sampleãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®åå‰ãŒæ°—ã«é£Ÿã‚ãªã‹ã£ãŸã‚‰ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

ç§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã—ãŸã€‚

```:inventory.ini
[kube_control_plane]
alma1 ansible_host=10.10.1.10 ip=10.10.1.10 etcd_member_name=etcd1

[etcd:children]
kube_control_plane

[kube_node]
alma-w1 ansible_host=10.10.1.11 ip=10.10.1.11
alma-w2 ansible_host=10.10.1.12 ip=10.10.1.12
```

- ansible_host: Ansibleå®Ÿè¡Œå¯¾è±¡ã®IPã§ã™ã€‚ansibleå®Ÿè¡Œãƒã‚·ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹IPã‚’æŒ‡å®šã—ã¾ã™ã€‚
- ip: k8sã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå¾…ã¡å—ã‘ã™ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ã€‚é€šå¸¸ã¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯å´ã®IPã‚’æŒ‡å®šã™ã‚‹ã®ã§ã™ãŒã€eth0å´ã¯å›ºå®šIPã«ã—ã¦ã„ãªã„ã®ã§eth1å´ã®IPã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
- etcd_member_name: etcdã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’è­˜åˆ¥ã™ã‚‹åå‰ã§ã™ã€‚etcdã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒãƒ¼ãƒ‰ã«ã¯ã“ã®å¤‰æ•°ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚


### ç‰¹æ¨©æ˜‡æ ¼ã™ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ç”¨æ„

kubesprayã«ã¯å®Ÿè¡Œæ™‚ã«rootæ¨©é™ãŒå¿…è¦ãªæ“ä½œãŒè¤‡æ•°å­˜åœ¨ã—ã¾ã™ã€‚
Ansibleå®Ÿè¡Œå¯¾è±¡ã§åˆ©ç”¨ã™ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒrootã§ã¯ãªã„å ´åˆã€Ansibleå®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’kubesprayã«æ•™ãˆã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚playbookå®Ÿè¡Œæ™‚ã«```-b```ã®ãƒ•ãƒ©ã‚°ã‚’ä½¿ã†ã‚‚ã®ã¨ã—ã¦ã€ansible_become_passwordã‚’ç”¨æ„ã—ã¾ã™ã€‚
æ¤œè¨¼ç’°å¢ƒã®ãƒ¬ãƒ™ãƒ«ã§ã¯ä¸è¦ã§ã™ãŒã€ä»Šå›ã¯ansible-vaultã‚’ä½¿ã£ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æš—å·åŒ–ã—ã¾ã™ã€‚

```
$ cd <kubesprayã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª>/inventory/mycluster/group_vars/all
$ export EDITOR=vim
$ ansible-vault create vault.yml
```
ã“ã“ã§Vault password (æš—å·åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã®å¾©å…ƒç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰) ã‚’æŒ‡å®šã—ã¾ã™ã€‚
ã™ã‚‹ã¨ã€vimã§ãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†ãŒã§ãã‚‹ã®ã§ã€ansible_become_passwordã‚’å…¥åŠ›ã—ã¾ã™ã€‚

```yaml:vault.yml
---
ansible_become_password: "<ä½¿ç”¨ã™ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰>"
```

:::message alert
Vault passwordã¯ç¹°ã‚Šè¿”ã—ä½¿ç”¨ã™ã‚‹ã®ã§å¿˜ã‚Œãªã„ã‚ˆã†ã«å®‰å…¨ãªå ´æ‰€ã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚
:::

EDITORå¤‰æ•°ã¯ansible-vaultã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ãŸéš›ã«ã€ã©ã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã‚’æŒ‡å®šã™ã‚‹ã‚‚ã®ã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯viã§ã™ãŒã€Alma Linux 9.6ã®WSLã«ã¯viãŒå…¥ã£ã¦ã„ãªã‹ã£ãŸãŸã‚ã€vimã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚


## kubesprayã®å®Ÿè¡Œ

### ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹å‰ã«
firewallã‚’æ­¢ã‚ã¦ãŠãã¾ã™ã€‚é©åˆ‡ãªãƒãƒ¼ãƒˆã‚’ã‚ã‚‰ã‹ã˜ã‚é–‹ã‘ã¦ã„ã‚‹ã®ãªã‚‰å¤§ä¸ˆå¤«ã§ã™ãŒã€è¨­å®šã—ã¦ã„ãªã„å ´åˆæ§‹ç¯‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚kubespray/contribé…ä¸‹ã«firewallã‚’æ­¢ã‚ã‚‹ãŸã‚ã®playbookãŒå­˜åœ¨ã™ã‚‹ã®ã§ã€ãã¡ã‚‰ã‚’ä½¿ã„ã¾ã™ã€‚

ã¾ãšdisable_service_firewallå¤‰æ•°ã‚’falseã‹ã‚‰trueã«æ›¸ãæ›ãˆã¾ã™ã€‚
ã“ã¡ã‚‰ã‚’æ›¸ãæ›ãˆãªã„ã¨firewallã‚’åœæ­¢ã™ã‚‹taskãŒskipã•ã‚Œã¾ã™ã€‚
```
$ cd <kubesprayã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª>
$ vim contrib/os-services/roles/prepare/defaults/main.yml
```
```yaml:main.yml
---
disable_service_firewall: true
```

æ¬¡ã«ã€firewallåœæ­¢ç”¨playbookï¼ˆcontrib/os-services/os-services.ymlï¼‰ã‚’æŒ‡å®šã—ã¦ã€ansibleã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```
$ ansible-playbook -i inventory/mycluster/inventory.ini -u <ansibleå®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼å> -b -v --ask-vault-pass --private-key=~/.ssh/id_ed25519 contrib/os-services/os-services.yml
```
--ask-vault-passã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦æš—å·åŒ–ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å·ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚vault passwordãŒèã‹ã‚Œã‚‹ã®ã§å…¥åŠ›ã—ã¾ã™ã€‚ã“ã‚Œã§å…¨å°ã®firewalldãŒåœæ­¢ã•ã‚Œã¾ã™ã€‚

### ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®æ§‹ç¯‰

ãã‚Œã§ã¯ã€k8sã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚Œã°æ§‹ç¯‰ãŒå§‹ã¾ã‚Šã¾ã™ã€‚
```
$ ansible-playbook -i inventory/mycluster/inventory.ini -u <ansibleå®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼å> -b -v --ask-vault-pass --private-key=~/.ssh/id_ed25519 cluster.yml
```
å®Ÿè¡Œæ™‚ã«vaut passwordã‚’å…¥åŠ›ã—ã¾ã™ã€‚
ä»Šå›ä½¿ã£ãŸæ§‹æˆã§ã¯10åˆ†ç¨‹åº¦ã§æ§‹ç¯‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚

å…¨ã¦ã‚’ç¢ºèªã—ãŸã‚ã‘ã§ã¯ãªã„ã§ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
```
[root@alma1 ~]# kubectl get nodes,all,secrets -A
NAME           STATUS   ROLES           AGE   VERSION
node/alma-w1   Ready    <none>          98m   v1.32.5
node/alma-w2   Ready    <none>          98m   v1.32.5
node/alma1     Ready    control-plane   98m   v1.32.5

NAMESPACE     NAME                                           READY   STATUS    RESTARTS   AGE
kube-system   pod/calico-kube-controllers-588d6df6c9-ccsld   1/1     Running   0          97m
kube-system   pod/calico-node-97j67                          1/1     Running   0          97m
kube-system   pod/calico-node-blj4v                          1/1     Running   0          97m
kube-system   pod/calico-node-kfbnv                          1/1     Running   0          97m
kube-system   pod/coredns-5c54f84c97-h62m9                   1/1     Running   0          97m
kube-system   pod/coredns-5c54f84c97-k8qt2                   1/1     Running   0          97m
kube-system   pod/dns-autoscaler-56cb45595c-b828j            1/1     Running   0          97m
kube-system   pod/kube-apiserver-alma1                       1/1     Running   1          98m
kube-system   pod/kube-controller-manager-alma1              1/1     Running   2          98m
kube-system   pod/kube-proxy-76tld                           1/1     Running   0          98m
kube-system   pod/kube-proxy-br289                           1/1     Running   0          98m
kube-system   pod/kube-proxy-v7cqg                           1/1     Running   0          98m
kube-system   pod/kube-scheduler-alma1                       1/1     Running   1          98m
kube-system   pod/nginx-proxy-alma-w1                        1/1     Running   0          98m
kube-system   pod/nginx-proxy-alma-w2                        1/1     Running   0          98m
kube-system   pod/nodelocaldns-4jmmh                         1/1     Running   0          97m
kube-system   pod/nodelocaldns-4vcqq                         1/1     Running   0          97m
kube-system   pod/nodelocaldns-td66c                         1/1     Running   0          97m

NAMESPACE     NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE
default       service/kubernetes   ClusterIP   10.233.0.1   <none>        443/TCP                  98m
kube-system   service/coredns      ClusterIP   10.233.0.3   <none>        53/UDP,53/TCP,9153/TCP   97m

NAMESPACE     NAME                          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
kube-system   daemonset.apps/calico-node    3         3         3       3            3           kubernetes.io/os=linux   97m
kube-system   daemonset.apps/kube-proxy     3         3         3       3            3           kubernetes.io/os=linux   98m
kube-system   daemonset.apps/nodelocaldns   3         3         3       3            3           kubernetes.io/os=linux   97m

NAMESPACE     NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE
kube-system   deployment.apps/calico-kube-controllers   1/1     1            1           97m
kube-system   deployment.apps/coredns                   2/2     2            2           97m
kube-system   deployment.apps/dns-autoscaler            1/1     1            1           97m

NAMESPACE     NAME                                                 DESIRED   CURRENT   READY   AGE
kube-system   replicaset.apps/calico-kube-controllers-588d6df6c9   1         1         1       97m
kube-system   replicaset.apps/coredns-5c54f84c97                   2         2         2       97m
kube-system   replicaset.apps/dns-autoscaler-56cb45595c            1         1         1       97m

NAMESPACE     NAME                            TYPE                            DATA   AGE
kube-system   secret/bootstrap-token-106kcc   bootstrap.kubernetes.io/token   4      98m
kube-system   secret/bootstrap-token-dyd7ys   bootstrap.kubernetes.io/token   6      98m
kube-system   secret/bootstrap-token-l5skvp   bootstrap.kubernetes.io/token   6      98m
kube-system   secret/bootstrap-token-m16j54   bootstrap.kubernetes.io/token   4      98m
kube-system   secret/bootstrap-token-rr9hxh   bootstrap.kubernetes.io/token   6      98m
kube-system   secret/bootstrap-token-wbrk3p   bootstrap.kubernetes.io/token   6      98m
kube-system   secret/kubeadm-certs            Opaque                          9      98m
```

ä¸Šè¨˜ã®å®Ÿè¡Œæ–¹æ³•ã§ã¯Ansibleå®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®```$HOME```ã«ã¯```.kube/config```ãŒä½œæˆã•ã‚Œã¾ã›ã‚“ã€‚rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆã¦ã‹ã‚‰kubectlã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

:::message
kubesprayã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’/usr/local/binã«é…ç½®ã—ã¾ã™ã€‚```sudo -i```ã‚³ãƒãƒ³ãƒ‰ã¨```sudo su -```ã‚³ãƒãƒ³ãƒ‰ã¯ã©ã¡ã‚‰ã‚‚rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç§»è¡Œã§ãã¾ã™ãŒã€rootã«ãªã£ãŸæ™‚ã«è¨­å®šã•ã‚Œã‚‹ç’°å¢ƒå¤‰æ•°ã«é•ã„ãŒå‡ºã¾ã™ã€‚
```sudo -i```ã§ã¯/usr/local/binãŒ$PATHã«è¨­å®šã•ã‚Œãªã„ã®ã§```sudo su -```ã‚’ä½¿ã„ã¾ã™ã€‚
:::

## kubesprayã‚’ä½¿ã†ã«ã‚ãŸã£ã¦èª¿ã¹ãŸã“ã¨

### net.ipv4.ip_forwardã®è¨­å®š

k8sã§ã¯ãƒãƒ¼ãƒ‰é–“ã®ãƒ‘ã‚±ãƒƒãƒˆè»¢é€ãªã©ã«IPè»¢é€æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ãã®ãŸã‚net.ipv4.ip_forwardã‚‚ã—ãã¯net.ipv6.ip_forwardãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®[Requirements](https://kubespray.io/#/?id=requirements)ã‚’èª­ã‚€ã¨ã€IPv4 forwardingãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚ãŸã ã€å‰è¿°ã®é€šã‚Škubesprayã®ä¸­ã§net.ipv4.ip_forwardã‚’æœ‰åŠ¹åŒ–ã™ã‚‹å‡¦ç†ãŒèµ°ã‚Šã¾ã—ãŸã€‚kubesprayå®Ÿè¡Œå‰ã«è¨­å®šã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã®ã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ã€‚

```yaml:kubespray/roles/kubernetes/preinstall/tasks/0080-system-configurations.yml
- name: Enable ip forwarding
  ansible.posix.sysctl:
    sysctl_file: "{{ sysctl_file_path }}"
    name: net.ipv4.ip_forward
    value: "1"
    state: present
    reload: true
  when: ipv4_stack | bool
```

### firewallã®è¨­å®š

ã“ã‚Œã¯[Requirements](https://kubespray.io/#/?id=requirements)ã®é€šã‚Šã§ã™ã€‚firewallã¯kubesprayã®ç®¡ç†å¯¾è±¡å¤–ãªã®ã§ã€ä¸€åº¦ç„¡åŠ¹åŒ–ã—ã€å¾Œã‹ã‚‰é©åˆ‡ãªãƒãƒ¼ãƒˆã‚’é–‹ã‘ã¦ãã ã•ã„ã€‚


### SELinuxã®è¨­å®š

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€ã¨```preinstall_selinux_state```ã¨ã„ã†å¤‰æ•°ã‚’æŒ‡å®šã§ãã‚‹ã¨æ›¸ã„ã¦ãŠã‚Š[^1]ã€SELinuxã‚’Enforcingã«ã—ã¦ã‚‚ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã§ããã†ãªé›°å›²æ°—ã¯ã‚ã‚Šã¾ã™ã€‚
ãŸã ã€ä¸Šè¨˜å¤‰æ•°ä»¥å¤–ã§SELinuxã«ã¤ã„ã¦è§¦ã‚Œã¦ãŠã‚‰ãšã€ã„ã‚ã„ã‚ãªãƒ–ãƒ­ã‚°ã‚’è¦‹ã‚‹ã¨SELinuxã¯ç„¡åŠ¹åŒ–ã™ã‚‹ã¨æ›¸ã„ã¦ã„ãŸã®ã§æ¤œè¨¼ã—ã¾ã—ãŸã€‚
[^1]: https://kubespray.io/#/docs/ansible/vars?id=common-vars-that-are-used-in-kubespray


ã¾ãšã¯SELinuxã®dontauditãƒ«ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã€‚dontauditãƒ«ãƒ¼ãƒ«ã¨ã¯ã‚µã‚¤ãƒ¬ãƒ³ãƒˆæ‹’å¦ã¨ã‚‚å‘¼ã°ã‚Œã‚‹ã€AVCæ‹’å¦ãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œãªã„ãƒ«ãƒ¼ãƒ«ã®äº‹ã§ã™ã€‚
ç„¡åŠ¹åŒ–ã—ã¦ã„ãªã„çŠ¶æ…‹ã§ã¯ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒé›£ã—ããªã‚Šã¾ã™ã€‚

ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹å‰ã«è¨­å®šã—ãŸã„ã®ã§ã€firewallåœæ­¢ç”¨playbookã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚
```yaml:kubespray/contrib/os-services/os-services.yml
- name: Disable SELinux dontaudit rules
  hosts: all
  become: yes
  tasks:
    - name: Install setools-console
      ansible.builtin.dnf:
        name: setools-console
        state: present

    - name: Disable dontaudit rules
      ansible.builtin.command: semodule -DB
      register: semodule_result
      changed_when: semodule_result.rc == 0
```

kubesprayã¯å®Ÿè¡Œä¸­ã«SELinuxã®çŠ¶æ…‹ã‚’å¤‰æ›´ã—ã¾ã™ã€‚å¤‰æ›´ã™ã‚‹å‡¦ç†ã¯ä»¥ä¸‹ã«ã‚ã‚Šã¾ã™ã€‚
```yaml:kubespray/roles/kubernetes/preinstall/tasks/0080-system-configurations.yml
- name: Set selinux policy
  ansible.posix.selinux:
    policy: targeted
    state: "{{ preinstall_selinux_state }}"
  when:
    - ansible_os_family == "RedHat"
    - "'Amazon' not in ansible_distribution"
    - slc.stat.exists
  tags:
    - bootstrap_os
```

```preinstall_selinux_state```ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯åˆ¥ã®roleã§è¨­å®šã•ã‚Œã¦ã„ã¾ã—ãŸã€‚ï¼ˆåˆã‚ã¦è¦‹ã‚‹æ›¸ãæ–¹ã§é©šãã¾ã—ãŸã€‚ï¼‰
```yaml:kubespray/roles/kubespray_defaults/defaults/main/main.yml
# selinux state
preinstall_selinux_state: permissive
```
ç¾çŠ¶ã®ã¾ã¾ã§ã¯permissiveã«ãªã‚‹ã®ã§ã€gruop_varsã‹ã‚‰ä¸Šæ›¸ãã—ã¾ã™ã€‚ä»¥ä¸‹ã®æœ«å°¾ã«ä¸‹è¨˜ã‚’è¿½è¨˜ã—ã¾ã™ã€‚
```yaml:kubespray/inventory/sample/group_vars/all/all.yml
preinstall_selinux_state: enforcing
```

æ¤œè¨¼æº–å‚™ã¯ã“ã‚Œã§OKã§ã™ã€‚[kubesprayã®å®Ÿè¡Œ](#kubesprayã®å®Ÿè¡Œ)ã¨åŒæ§˜ã®æ‰‹é †ã§ansible-playbookã‚³ãƒãƒ³ãƒ‰ã‚’2å›å®Ÿè¡Œã—ã¾ã™ã€‚

kubesprayã¯ansibleã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ã„ã‚‹ã®ã§ã€å®Ÿè¡Œå¾Œã«ã¯RECAPãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ãã“ã§failedã¨ignoreeã®æ•°ã‚’Permissive/Enforcingã§æ¯”è¼ƒã—ã¦ã‚‚é•ã„ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
ã¾ãŸã€ã„ãã¤ã‹ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¾ã—ãŸãŒã€Permissiveã®æ™‚ã¨åŒæ§˜ã®çµæœã‚’å¾—ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚
```
[root@alma1 ~]# kubectl get nodes,all,secrets -A
NAME           STATUS   ROLES           AGE   VERSION
node/alma-w1   Ready    <none>          44m   v1.32.5
node/alma-w2   Ready    <none>          44m   v1.32.5
node/alma1     Ready    control-plane   44m   v1.32.5

NAMESPACE     NAME                                           READY   STATUS    RESTARTS   AGE
kube-system   pod/calico-kube-controllers-588d6df6c9-zlgxb   1/1     Running   0          43m
kube-system   pod/calico-node-djwpq                          1/1     Running   0          43m
kube-system   pod/calico-node-gt94m                          1/1     Running   0          43m
kube-system   pod/calico-node-n8vsv                          1/1     Running   0          43m
kube-system   pod/coredns-5c54f84c97-mmtnc                   1/1     Running   0          43m
kube-system   pod/coredns-5c54f84c97-xcp5h                   1/1     Running   0          43m
kube-system   pod/dns-autoscaler-56cb45595c-ch9mv            1/1     Running   0          43m
kube-system   pod/kube-apiserver-alma1                       1/1     Running   1          44m
kube-system   pod/kube-controller-manager-alma1              1/1     Running   2          44m
kube-system   pod/kube-proxy-9x52n                           1/1     Running   0          44m
kube-system   pod/kube-proxy-c8jzv                           1/1     Running   0          44m
kube-system   pod/kube-proxy-v8bwv                           1/1     Running   0          44m
kube-system   pod/kube-scheduler-alma1                       1/1     Running   1          44m
kube-system   pod/nginx-proxy-alma-w1                        1/1     Running   0          44m
kube-system   pod/nginx-proxy-alma-w2                        1/1     Running   0          44m
kube-system   pod/nodelocaldns-jjlxh                         1/1     Running   0          43m
kube-system   pod/nodelocaldns-qw5bn                         1/1     Running   0          43m
kube-system   pod/nodelocaldns-tx8j2                         1/1     Running   0          43m

NAMESPACE     NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE
default       service/kubernetes   ClusterIP   10.233.0.1   <none>        443/TCP                  44m
kube-system   service/coredns      ClusterIP   10.233.0.3   <none>        53/UDP,53/TCP,9153/TCP   43m

NAMESPACE     NAME                          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
kube-system   daemonset.apps/calico-node    3         3         3       3            3           kubernetes.io/os=linux   43m
kube-system   daemonset.apps/kube-proxy     3         3         3       3            3           kubernetes.io/os=linux   44m
kube-system   daemonset.apps/nodelocaldns   3         3         3       3            3           kubernetes.io/os=linux   43m

NAMESPACE     NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE
kube-system   deployment.apps/calico-kube-controllers   1/1     1            1           43m
kube-system   deployment.apps/coredns                   2/2     2            2           43m
kube-system   deployment.apps/dns-autoscaler            1/1     1            1           43m

NAMESPACE     NAME                                                 DESIRED   CURRENT   READY   AGE
kube-system   replicaset.apps/calico-kube-controllers-588d6df6c9   1         1         1       43m
kube-system   replicaset.apps/coredns-5c54f84c97                   2         2         2       43m
kube-system   replicaset.apps/dns-autoscaler-56cb45595c            1         1         1       43m

NAMESPACE     NAME                            TYPE                            DATA   AGE
kube-system   secret/bootstrap-token-16bbjs   bootstrap.kubernetes.io/token   6      44m
kube-system   secret/bootstrap-token-3ryr54   bootstrap.kubernetes.io/token   4      44m
kube-system   secret/bootstrap-token-c56lx6   bootstrap.kubernetes.io/token   6      44m
kube-system   secret/bootstrap-token-gcbiw7   bootstrap.kubernetes.io/token   6      44m
kube-system   secret/bootstrap-token-h45avh   bootstrap.kubernetes.io/token   6      44m
kube-system   secret/bootstrap-token-yy26qe   bootstrap.kubernetes.io/token   4      44m
kube-system   secret/kubeadm-certs            Opaque                          9      44m
```

ãŸã ã—ã€æ‹’å¦ãƒ­ã‚°ãŒä½•ç¨®é¡ã‹å‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚
```
# ausearch -m AVC,USER_AVC,SELINUX_ERR,USER_SELINUX_ERR
```
ä¾‹ãˆã°ä»¥ä¸‹ã®ãƒ­ã‚°ã§ã™ã€‚
```
avc:  denied  { read write } for  pid=43198 comm="unix_chkpwd" path="/dev/pts/1" dev="devpts" ino=4 scontext=unconfined_u:unconfined_r:chkpwd_t:s0-s0:c0.c1023 tcontext=unconfined_u:object_r:user_devpts_t:s0 tclass=chr_file permissive=0
```
ä»Šå›ã¯ä½•ã®æ“ä½œãŒæ‹’å¦ã•ã‚ŒãŸã‹ã‚’èª¿ã¹ã‚‹ã®ã“ã¨ã¾ã§ã—ã¾ã›ã‚“ï¼ˆã¡ã‚‡ã£ã¨åŠ›ã¤ãã¾ã—ãŸï¼‰ã€‚ä½•ã‹ã—ã‚‰ã®æ“ä½œãŒä¸Šæ‰‹ãã„ã£ã¦ã„ãªã„ã¯ãšã§ã™ã®ã§ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹ç¯‰ã¯SELinuxã‚’Permissiveã‚‚ã—ãã¯Disabledã«ã—ã¦ãŠãã®ãŒç„¡é›£ã§ã—ã‚‡ã†ã€‚

## ã¾ã¨ã‚

ã¨ã„ã†ã‚ã‘ã§ã€kubesprayã‚’ä½¿ã£ã¦ã®k8sã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹ç¯‰æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚Ansibleã‚’ä½¿ãˆã‚‹æ–¹ã§ã—ãŸã‚‰ç°¡å˜ã«k8sã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ã§ãã‚‹ãŸã‚éå¸¸ã«ä½¿ã„å‹æ‰‹ã®ã„ã„ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã ã¨æ€ã„ã¾ã™ã€‚
ä»Šå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ã£ãŸã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹ç¯‰ã®å†…å®¹ã«ã¨ã©ã¾ã‚Šã¾ã—ãŸãŒã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ãƒãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã—ã€kubesprayã¯containerdã®ä»£ã‚ã‚Šã«cri-oã‚’ä½¿ç”¨ã™ã‚‹ã€NWãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å¤‰æ›´ã™ã‚‹ãªã©ã®æŸ”è»Ÿãªæ‹¡å¼µãŒå¯èƒ½ãªã‚ˆã†ã§ã™ã€‚
ã“ã“ã‚‰è¾ºã¯ã¾ãŸãã®ã†ã¡æ¤œè¨¼ã—ã€è¨˜äº‹ã¨ã—ã¦å…¬é–‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚
