---
title: "ã€å°ãƒã‚¿ã€‘ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å›åã™ã‚‹æ–¹æ³•"
emoji: "ğŸ³"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Docker]
published: true
---

# ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å›åã™ã‚‹æ–¹æ³•

ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰æ™‚ã«ä¸€åº¦COPYã—ã€å¾Œã®å‘½ä»¤ã§å‰Šé™¤ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ã—ã°ã‚‰ãå¾Œã«ãªã£ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰å–ã‚Šå‡ºã—ãŸããªã£ãŸã“ã¨ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿç§ã¯ã‚ã‚Šã¾ã™ã€‚[^1]

[^1]: å…ˆäººãŒã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã£ãŸéš›ã«Gitã§ç®¡ç†ã—ã¦ã„ãªã„è¨¼æ˜æ›¸ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«é…ç½®ã—ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ã‚­ãƒ¼ã‚¹ãƒˆã‚¢æ ¼ç´å¾Œã«è¨¼æ˜æ›¸ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰æ¶ˆå»ã—ã¦ã„ãŸã®ã§ã™ãŒã€ç§ãŒã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚Šç›´ã™éš›ã«ãã®è¨¼æ˜æ›¸ã®åŸæœ¬ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã¨ã„ã†çµŒé¨“ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚“ãªæ™‚ã€ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å›åã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ã‚³ãƒ³ãƒ†ãƒŠã®layerã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å›åã™ã‚‹æ‰‹æ³•ã«ã¤ã„ã¦è¨˜è¼‰ã—ã¾ã™ã€‚

## çµè«–

ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰æ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹æ“ä½œã¨å‰Šé™¤ã™ã‚‹æ“ä½œãŒåˆ¥ã€…ã®layerã¨ãªã£ã¦ã„ã‚‹å ´åˆã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å½¢å¼ã§å‡ºåŠ›ã—ã¦ã‚ã’ã‚‹ã“ã¨ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–ã‚Šå‡ºã™ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

## ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®æ§‹é€ ã«ã¤ã„ã¦

ã„ã‚ã„ã‚ãªã¨ã“ã‚ã§è§£èª¬ã•ã‚Œã¦ã„ã‚‹ã®ã§å°‘ã—ã®æ¦‚è¦ã ã‘è¨˜è¼‰ã—ã¾ã™ã€‚
ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã¯layerã¨å‘¼ã°ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’é‡ã­åˆã‚ã›ã‚‹ï¼ˆç©ã¿ä¸Šã’ã‚‹ï¼‰ã“ã¨ã§ä½œã‚‰ã‚Œã¾ã™ã€‚Dockerfileã®ä¸€éƒ¨ã®å‘½ä»¤ã”ã¨ã«æ–°ã—ã„layerãŒä½œã‚‰ã‚Œ[^2]ã€ãã“ã§ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®è¿½åŠ ãƒ»å¤‰æ›´ãƒ»å‰Šé™¤ãªã©ã®å‡¦ç†ãŒç™ºç”Ÿã—ã¾ã™ã€‚
ç©ã¿ä¸Šã’ã‚‰ã‚ŒãŸlayerã¯ä¸‹ä½ã®layerã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¶™æ‰¿ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€ä¸Šä½ã®layerã¯ä¸‹ä½ã®layerã«å¯¾ã™ã‚‹å·®åˆ†ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¨ãªã‚Šã¾ã™ã€‚
æœ€çµ‚çš„ã«ã€åŸºã¨ãªã£ãŸã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«å¯¾ã™ã‚‹å·®åˆ†ã®é›†åˆãŒæ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ãªã‚Šã¾ã™ã€‚

[^2]: ä¸€éƒ¨ã®å‘½ä»¤ã¯ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã®ã¿ãŒç™ºç”Ÿã—ã€ãã®å ´åˆã¯layerã¯ä½œã‚‰ã‚Œã¾ã›ã‚“ã€‚

## æ¤œè¨¼

### ã‚·ãƒŠãƒªã‚ª

ä»Šå›ã¯ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ã‚’æƒ³å®šã—ã¦æ¤œè¨¼ã—ã¾ã™ã€‚

- AlmaLinux 9.6ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«å¯¾ã—ã¦è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’ç™»éŒ²ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’å–ã‚Šå‡ºã™ã€‚
- è‡ªå·±ç½²åè¨¼æ˜æ›¸ã¯COPYå‘½ä»¤ã§ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã€‚

### ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ

1. è‡ªå·±ç½²åè¨¼æ˜æ›¸ä½œæˆ

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§256 ãƒ“ãƒƒãƒˆã®æ¥•å††æ›²ç·šãƒ‡ã‚¸ã‚¿ãƒ«ç½²åã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  (ECDSA) ã‚­ãƒ¼ã¨ã€ãã®éµã§ç½²åã•ã‚ŒãŸè‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’ä½œæˆã—ã¾ã™ã€‚
è¨¼æ˜æ›¸ä½œæˆæ™‚ã®è³ªå•ã«ã¯é©å½“ã«å›ç­”ã—ã¦ã„ã¾ã™ã€‚

```
$ openssl genpkey -algorithm ec -pkeyopt ec_paramgen_curve:P-256 -out private.key
$ openssl req -key private.key -new -x509 -days 3650 -out server.crt
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:JA
State or Province Name (full name) []:Tokyo
Locality Name (eg, city) [Default City]:Tokyo
Organization Name (eg, company) [Default Company Ltd]:Hoge
Organizational Unit Name (eg, section) []:Fuga
Common Name (eg, your name or your server's hostname) []:Test For Container Layer
Email Address []:
```

2. Dockerfileã®ç”¨æ„

æ¬¡ã«ã€ä»¥ä¸‹ã®Dockerfileã‚’ç”¨æ„ã—ã¾ã™ã€‚
```:Dockerfile
FROM almalinux:9.6-minimal
COPY server.crt /tmp/server.crt
RUN trust anchor /tmp/server.crt && rm /tmp/server.crt
```

Dockerfileã¨åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å…ˆã»ã©ä½œæˆã—ãŸserver.crtã¨ã„ã†è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’é…ç½®ã—ã¦ãŠãã¾ã™ã€‚


3. ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰

ã‚¤ãƒ¡ãƒ¼ã‚¸åã¯```test-file1```ã§ä½œæˆã—ã¾ã—ãŸã€‚
```
$ docker build -t test-file1 .
```

### ã‚³ãƒ³ãƒ†ãƒŠã®ç¢ºèª

è¨¼æ˜æ›¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã¨ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã®/tmp/é…ä¸‹ã«server.crtãŒå­˜åœ¨ã—ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

ãƒ›ã‚¹ãƒˆã‚µãƒ¼ãƒãƒ¼ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
```
$ docker run -it test-file1:latest /bin/bash
```
ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚Œã‚‹ã®ã§ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œ
```
# ls /tmp/
```
â‡’ä½•ã‚‚ãªã—

```
# trust list | grep -C 3 "Test For Container Layer"
pkcs11:id=%6E%6B%7C%89%F1%C1%AF%A1%8C%32%2E%ED%EE%B9%77%F6%75%DB%E6%EE;type=cert
    type: certificate
    label: Test For Container Layer
    trust: anchor
    category: authority
```
â‡’è¨¼æ˜æ›¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿

### ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã®å–ã‚Šå‡ºã—

layerã‹ã‚‰server.crtãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–ã‚Šå‡ºã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ãã®å‰ã«ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ãŒã©ã®ã‚ˆã†ã«ä½œæˆã•ã‚ŒãŸã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
$ docker image history test-file1:latest
IMAGE          CREATED        CREATED BY                                      SIZE      COMMENT
c228ba78cd96   28 hours ago   RUN /bin/sh -c trust anchor /tmp/server.crt â€¦   2.59MB    buildkit.dockerfile.v0
<missing>      28 hours ago   COPY server.crt /tmp/server.crt # buildkit      12.3kB    buildkit.dockerfile.v0
<missing>      3 weeks ago    CMD ["/bin/bash"]                               0B        buildkit.dockerfile.v0
<missing>      3 weeks ago    ADD almalinux-9-minimal-amd64.tar.xz / # buiâ€¦   100MB     buildkit.dockerfile.v0
```
ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã¯4ã¤ã®å‘½ä»¤ã§ä½œæˆã•ã‚ŒãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚ã¾ãŸãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦ä½¿ã£ãŸ```almalinux:9.6-minimal```ã¯2ã¤ã®å‘½ä»¤ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã‹ã‚Šã¾ã™ã€‚
ä¸Šè¨˜ã®CMDå‘½ä»¤ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’æ›´æ–°ã—ã¦ãŠã‚Šlayerã¯ä½œæˆã—ã¦ãŠã‚Šã¾ã›ã‚“ã€‚[^3] ã‚µã‚¤ã‚ºãŒ0Bã¨ãªã£ã¦ãŠã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦ã®å®Ÿä½“ã¯å­˜åœ¨ã—ãªã„ã¨ã‚ã‹ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ä»Šå›ä½œæˆã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã¯3ã¤ã®layerã‹ã‚‰æˆã‚Šç«‹ã¤ã¨ã‚ã‹ã‚Šã¾ã™ã€‚
ãã—ã¦ã€ãã®ä¸­ã§ã‚‚server.crtã‚’COPYã™ã‚‹layerãŒä¸€ç•ªã‚µã‚¤ã‚ºãŒå°ã•ã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

[^3]: the CMD instruction specifies what command to run within the container, which only modifies the image's metadata, which doesn't produce an image layer.
https://docs.docker.com/engine/storage/drivers/#images-and-layers

æ¬¡ã«ã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’tarã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å½¢å¼ã§å‡ºåŠ›ã—ã€å±•é–‹ã—ã¾ã™ã€‚
```
$ docker save -o test-image1.tar test-file1:latest
$ tar xvf test-image1.tar
$ tree
.
â”œâ”€â”€ blobs
â”‚Â Â  â””â”€â”€ sha256
â”‚Â Â      â”œâ”€â”€ 0314125dcb23155573a7a82bdb451831255511518bb2c5607551e426a51fe0fb
â”‚Â Â      â”œâ”€â”€ 17c600215b50e243dc5bf3a666a193840ff4e68310b66bde3003f10366401abc
â”‚Â Â      â”œâ”€â”€ 2b1071f7deac7631c1a9de9378237b74f4654a380a7c4b4b9ceeb6e78e2f99cf
â”‚Â Â      â”œâ”€â”€ 37da69bd02c3220597afbbfdd49922e08b9f89cfcf5e29067cb46ee393f6fb70
â”‚Â Â      â”œâ”€â”€ 5ab4867ca216bd36f064f616e11af25749f013448e7e9824cb6e98e9855d5d8f
â”‚Â Â      â”œâ”€â”€ 9d153035aad48be5b2a3116f4e69a6f01db78a4698a4f640c38038a657607f1a
â”‚Â Â      â”œâ”€â”€ c228ba78cd96288c514065e6c55acea2b50ab725bc4139a8c874d1c10f74b858
â”‚Â Â      â”œâ”€â”€ d0a899768c3c96bb235feb30e125bad7ef8b9d6498f3dfd3ffef204609ced811
â”‚Â Â      â””â”€â”€ d2275536f4d25bc83cead2de1a6968b264533bea554fab03cf3ce5512f574e37
â”œâ”€â”€ index.json
â”œâ”€â”€ manifest.json
â”œâ”€â”€ oci-layout
â””â”€â”€ test-image1.tar
```
ã“ã®```blobs/sha256```é…ä¸‹ã«layerã®ãƒ‡ãƒ¼ã‚¿ãŒæ ¼ç´ã•ã‚Œã¦ãŠã‚Šã¾ã™ã€‚ã“ã“ã«ã¯ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜è¿°ã—ãŸJSONã‚‚å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€layeræ•°ã‚ˆã‚Šã‚‚å¤šãã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚
layerã¯tar.gzã§åœ§ç¸®ã•ã‚Œã¦ã„ã¾ã™ã®ã§ã€fileã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ãˆã°layerãƒ‡ãƒ¼ã‚¿ã‚’åˆ¤åˆ¥ã§ãã¾ã™ã€‚

```
$ cd blobs/sha256
$ file *
0314125dcb23155573a7a82bdb451831255511518bb2c5607551e426a51fe0fb: gzip compressed data, original size modulo 2^32 94177280
17c600215b50e243dc5bf3a666a193840ff4e68310b66bde3003f10366401abc: JSON data
2b1071f7deac7631c1a9de9378237b74f4654a380a7c4b4b9ceeb6e78e2f99cf: JSON data
37da69bd02c3220597afbbfdd49922e08b9f89cfcf5e29067cb46ee393f6fb70: gzip compressed data, original size modulo 2^32 2376704
5ab4867ca216bd36f064f616e11af25749f013448e7e9824cb6e98e9855d5d8f: JSON data
9d153035aad48be5b2a3116f4e69a6f01db78a4698a4f640c38038a657607f1a: JSON data
c228ba78cd96288c514065e6c55acea2b50ab725bc4139a8c874d1c10f74b858: JSON data
d0a899768c3c96bb235feb30e125bad7ef8b9d6498f3dfd3ffef204609ced811: gzip compressed data, original size modulo 2^32 3072
d2275536f4d25bc83cead2de1a6968b264533bea554fab03cf3ce5512f574e37: JSON data
```
gzip compressed dataãŒç‰¹å®šã§ãã¾ã—ãŸã€‚ã¾ãŸã€ãã®ä¸­ã§ã‚‚```d0a899768c3c96bb235feb30e125bad7ef8b9d6498f3dfd3ffef204609ced811```ãŒä¸€ç•ªãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå°ã•ã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
server.crtã‚’COPYã—ãŸlayerãŒä¸€ç•ªãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå°ã•ã‹ã£ãŸã®ã§ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¯¾è±¡ã®layerã ã¨åˆ¤æ–­ã§ãã¾ã™ã€‚

```
$ tar xvf d0a899768c3c96bb235feb30e125bad7ef8b9d6498f3dfd3ffef204609ced811
tmp/
tmp/server.crt
```
å½“ãŸã‚Šã§ã™ã€‚
```
$ cd tmp/
$ ls
server.crt
```
ã“ã®server.crtãŒã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«æ ¼ç´ã—ãŸè‡ªå·±ç½²åè¨¼æ˜æ›¸ã¨ãªã‚Šã¾ã™ã€‚

## ã“ã®æ–¹æ³•ãŒä½¿ãˆãªã„ã‚±ãƒ¼ã‚¹

ã“ã®æ–¹æ³•ã¯å–ã‚Šå‡ºã—ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’COPYå‘½ä»¤ã§è¿½åŠ ã—ã¦ã„ã‚‹ï¼ˆlayerã¨ã—ã¦æ®‹ã£ã¦ã„ã‚‹ï¼‰å ´åˆã«ä½¿ãˆã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªDockerfileã®å ´åˆã¯layerãŒæ®‹ã‚‰ãªã„ã®ã§ä½¿ãˆã¾ã›ã‚“ã€‚
```:RUN.Dockerfile
FROM almalinux:9.6-minimal
RUN --mount=type=secret,id=server.crt \
  trust anchor /run/secrets/server.crt
```

ä¸Šè¨˜ã®Dockerfileã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã€ç¢ºèªã—ã¾ã™ã€‚

ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«secretã‚’æ¸¡ã—ã¾ã™ã€‚
```
$ docker build --secret id=server.crt,src=server.crt -f RUN.Dockerfile -t test-file2 .
```

COPYå‘½ä»¤ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ãŸã¨ãã¨æ¯”è¼ƒã—ã¦ãƒ¬ã‚¤ãƒ¤æ•°ã¯æ¸›ã‚Šã¾ã™ã€‚
```
$ docker image history test-file2:latest
IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT
dee5d880039d   3 minutes ago   RUN /bin/sh -c trust anchor /run/secrets/serâ€¦   2.58MB    buildkit.dockerfile.v0
<missing>      3 weeks ago     CMD ["/bin/bash"]                               0B        buildkit.dockerfile.v0
<missing>      3 weeks ago     ADD almalinux-9-minimal-amd64.tar.xz / # buiâ€¦   100MB     buildkit.dockerfile.v0
```

ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã¦ã€ä¸­èº«ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
$ docker run -it --rm test-file2:latest /bin/bash
```

è¨¼æ˜æ›¸ã¯æ®‹ã£ã¦ã„ã¾ã›ã‚“ã€‚
```
# ls /run/
lock
```

è¨¼æ˜æ›¸ã¯ã¡ã‚ƒã‚“ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã™ã€‚
```
# trust list | grep -C 3 "Test For Container Layer"
pkcs11:id=%6E%6B%7C%89%F1%C1%AF%A1%8C%32%2E%ED%EE%B9%77%F6%75%DB%E6%EE;type=cert
    type: certificate
    label: Test For Container Layer
    trust: anchor
    category: authority
```

ã¡ã‚ƒã‚“ã¨tarã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«å‡ºåŠ›ã—ã€layerã‚’è¦‹ã¦ã¿ã¾ã™ã€‚
```
$ docker save -o test-image2.tar test-file2:latest
$ tar xvf test-image2.tar
$ tree
.
â”œâ”€â”€ blobs
â”‚Â Â  â””â”€â”€ sha256
â”‚Â Â      â”œâ”€â”€ 0314125dcb23155573a7a82bdb451831255511518bb2c5607551e426a51fe0fb
â”‚Â Â      â”œâ”€â”€ 3e40baffd015881c5051785d7e982fdd23a0439c4882cb2e2ad7eee72295aa8f
â”‚Â Â      â”œâ”€â”€ 418dd1691817eaeb86cd3c11663b10dee089ee2dcd6c43879e7ea506f7494015
â”‚Â Â      â”œâ”€â”€ 4364e021bcd1fb14069012fe65182b5b6e41314f7908fa8a3d56e94c4b203a50
â”‚Â Â      â”œâ”€â”€ 7ed0f91a9653adca0bd7ece3dfa16a744ad7160ae4de4681f6d3faedaf11cf23
â”‚Â Â      â”œâ”€â”€ cd4318217b215a6b2982dbd769f7ddc90993c568bdac591ba428e1b50eced1c7
â”‚Â Â      â”œâ”€â”€ dee5d880039db5130a4fbcbb0d067af2a8f9747ab21469ccc94e51d0f62c6ee4
â”‚Â Â      â””â”€â”€ f8a8c5b5de2707fa9a0cb58fc4cae92c989daeafb7200314656930c10d0b6c57
â”œâ”€â”€ index.json
â”œâ”€â”€ manifest.json
â”œâ”€â”€ oci-layout
â””â”€â”€ test-image2.tar

$ cd blobs/sha256/
[hirata@DESKTOP-1M5IR3H sha256]$ file *
0314125dcb23155573a7a82bdb451831255511518bb2c5607551e426a51fe0fb: gzip compressed data, original size modulo 2^32 94177280
3e40baffd015881c5051785d7e982fdd23a0439c4882cb2e2ad7eee72295aa8f: JSON data
418dd1691817eaeb86cd3c11663b10dee089ee2dcd6c43879e7ea506f7494015: JSON data
4364e021bcd1fb14069012fe65182b5b6e41314f7908fa8a3d56e94c4b203a50: gzip compressed data, original size modulo 2^32 2375680
7ed0f91a9653adca0bd7ece3dfa16a744ad7160ae4de4681f6d3faedaf11cf23: JSON data
cd4318217b215a6b2982dbd769f7ddc90993c568bdac591ba428e1b50eced1c7: JSON data
dee5d880039db5130a4fbcbb0d067af2a8f9747ab21469ccc94e51d0f62c6ee4: JSON data
f8a8c5b5de2707fa9a0cb58fc4cae92c989daeafb7200314656930c10d0b6c57: JSON data
```
åˆ†ã‹ã£ã¦ã„ãŸã“ã¨ã§ã™ãŒã€layeræ•°ãŒå°‘ãªã„ã§ã™ã€‚

ã“ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹éš›ã«è¿½åŠ ã•ã‚ŒãŸlayerã‚’è¦‹ã¦ã‚‚ã€è¨¼æ˜æ›¸ã¯æ®‹ã£ã¦ã„ã¾ã›ã‚“ã€‚
```
$ tar tf 4364e021bcd1fb14069012fe65182b5b6e41314f7908fa8a3d56e94c4b203a50
etc/
etc/pki/
etc/pki/ca-trust/
etc/pki/ca-trust/extracted/
etc/pki/ca-trust/extracted/edk2/
etc/pki/ca-trust/extracted/edk2/cacerts.bin
etc/pki/ca-trust/extracted/java/
etc/pki/ca-trust/extracted/java/cacerts
etc/pki/ca-trust/extracted/openssl/
etc/pki/ca-trust/extracted/openssl/ca-bundle.trust.crt
etc/pki/ca-trust/extracted/pem/
etc/pki/ca-trust/extracted/pem/directory-hash/
etc/pki/ca-trust/extracted/pem/directory-hash/002c0b4f.0
~ç•¥~
etc/pki/ca-trust/extracted/pem/directory-hash/ffa7f1eb.0
etc/pki/ca-trust/extracted/pem/directory-hash/vTrus_ECC_Root_CA.pem
etc/pki/ca-trust/extracted/pem/directory-hash/vTrus_Root_CA.pem
etc/pki/ca-trust/extracted/pem/email-ca-bundle.pem
etc/pki/ca-trust/extracted/pem/objsign-ca-bundle.pem
etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem
etc/pki/ca-trust/source/
etc/pki/ca-trust/source/Test_For_Container_Layer.p11-kit
```
ã¨ã„ã†ã‚ã‘ã§ã€RUN --mountã®æ–¹æ³•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã•ã‚Œã¦ã„ãŸå ´åˆã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å›åã§ãã¾ã›ã‚“ã€‚

## æœ€å¾Œã«
ã¡ã‚‡ã£ã¨ã—ãŸå°ãƒã‚¿ã§ã—ãŸã€‚Union file systemãªã©ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ§‹æˆã™ã‚‹æŠ€è¡“ã‚’çŸ¥ã£ã¦ãŠãã¨ã€ã“ã®ã‚ˆã†ãªæ‰‹æ®µã‚’ã¨ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
å¾Œã‚ã®æ–¹ã§è»½ãè§¦ã‚ŒãŸRUN --mountã‚’ä½¿ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®è¿½åŠ ã§ã™ãŒã€COPYã‚³ãƒãƒ³ãƒ‰ã®ä½¿ã„åˆ†ã‘ãªã©ã¯[ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](https://docs.docker.com/build/building/best-practices/)ã«ã‚‚è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ã®ã§å‹‰å¼·ã—ã¦ã¿ã¦ãã ã•ã„ã€‚